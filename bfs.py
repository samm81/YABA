from search_problem import ArbitrageSearchProblem
from search_problem import ArbitrageSearchNode

def brutebfs(problem):
  start = problem.getStartState()
  q = []
  q.append(start)
  back = {}
  back[start] = None

  bestActions = []
  bestValue = 0

  while len(q) > 0:
    cur = q.pop(0)

    if problem.isGoalState(cur):
      value = problem.value(cur)
      if value > bestValue:
        bestValue = value
        actions = [cur]
        while cur != start:
          back_node, _ = back[(cur[0], cur[1], cur[3])]
          actions.append(back_node)
          cur = back_node
        bestActions = reversed(actions)

    for succ in problem.getSuccessors(cur):
      state = (succ[0], succ[1], succ[3])
      if (state in back and back[state][1] < succ[2]) or state not in back:
        q.append(succ)
        back[state] = (cur, succ[2])

  return (list(bestActions), bestValue)

class TestProblem():
  def __init__(self, trades, start):
    self.trades = trades
    self.start = start

  def getStartState(self):
    return self.start

  def isGoalState(self, state):
    # can change this to also match same market
    _, start_currency, _, _, _ = self.start
    _, currency, _, _, _ = state
    return start_currency == currency

  def value(self, state):
    _, _, _, amount, _ = state
    return amount

  def getSuccessors(self, state):
    succs = []
    exchange, currency, time, amount, stayed = state
    for succ, conversion_rate in self.trades[(exchange, currency, time, stayed)]:
      exchange_, currency_, time_, stayed_ = succ
      succs.append( (exchange_, currency_, time_, amount * conversion_rate, stayed_) )
    return succs

# TODO this fails half the time (why is it not deterministic ???)
if __name__ == '__main__':
  predictions_tree = {'gemini': {('USD', 'ETH'): [(0.0035207548498398058, 0), (0.0034491054135410747, 0), (0.0034245978732398534, 0), (0.0034000903329386317, 0), (0.0033755827926374104, 0), (0.0033510752523361895, 0), (0.0033265677120349678, 0)], ('USD', 'BTC'): [(0.00026983124753778985, 0), (0.0002674355608446523, 0), (0.00026636540052782674, 0), (0.00026529524021100124, 0), (0.00026422507989417568, 0), (0.00026315491957735012, 0), (0.00026208475926052456, 0)], ('ETH', 'USD'): [(284.02999999999997, 0), (289.83469002263297, 0), (291.81115793203463, 0), (293.7876258414363, 0), (295.7640937508379, 0), (297.74056166023956, 0), (299.71702956964123, 0)], ('ETH', 'BTC'): [(0.077295859169675282, 0), (0.077808317477638125, 0), (0.078091016266845059, 0), (0.078373715056052007, 0), (0.078656413845258955, 0), (0.078939112634465888, 0), (0.07922181142367285, 0)], ('BTC', 'ETH'): [(12.93730363750611, 0), (12.850123822042328, 0), (12.802013208214728, 0), (12.753902594387128, 0), (12.705791980559527, 0), (12.657681366731927, 0), (12.609570752904329, 0)], ('BTC', 'USD'): [(3706.02, 0), (3738.9343288357964, 0), (3753.6026394385954, 0), (3768.2709500413935, 0), (3782.939260644192, 0), (3797.6075712469906, 0), (3812.2758818497891, 0)]}, 'bitstamp': {('USD', 'ETH'): [(0.0035210027815921977, 0), (0.003455360303930761, 0), (0.0034320389222397578, 0), (0.0034087175405487541, 0), (0.0033853961588577505, 0), (0.0033620747771667472, 0), (0.003338753395475744, 0)], ('USD', 'BTC'): [(0.00026990553306342779, 0), (0.00026791407188251975, 0), (0.00026701321286188331, 0), (0.00026611235384124693, 0), (0.00026521149482061049, 0), (0.00026431063579997405, 0), (0.00026340977677933767, 0)], ('ETH', 'USD'): [(284.00999999999999, 0), (289.30750445922899, 0), (291.18107371112109, 0), (293.05464296301318, 0), (294.92821221490527, 0), (296.80178146679731, 0), (298.67535071868934, 0)], ('ETH', 'BTC'): [(0.077176788124156542, 0), (0.077861907380930226, 0), (0.078154281240620196, 0), (0.078446655100310153, 0), (0.078739028960000124, 0), (0.07903140281969008, 0), (0.079323776679380037, 0)], ('BTC', 'ETH'): [(12.957263761628314, 0), (12.841344713025856, 0), (12.791762219604779,0), (12.742179726183702, 0), (12.692597232762626, 0), (12.643014739341549, 0), (12.593432245920473, 0)], ('BTC', 'USD'): [(3705.0, 0), (3732.274558027947, 0), (3744.5990600190385, 0), (3756.9235620101304, 0), (3769.2480640012218, 0), (3781.5725659923137, 0), (3793.8970679834047, 0)]}, 'btcc': {('USD', 'BTC'): [(0.00026881720430107527, 0), (0.00026801355306357481, 0), (0.00026891458725944824, 0), (0.00026981562145532168, 0), (0.00027071665565119512, 0), (0.00027161768984706856, 0), (0.000272518724042942, 0)], ('BTC', 'USD'): [(3720.0, 0), (3736.3350941849499, 0), (3726.1763771066717, 0), (3716.017660028393, 0), (3705.8589429501149, 0), (3695.7002258718367, 0), (3685.541508793558,0)]}, 'kraken': {('USD', 'ETH'): [(0.0035031177748195896, 0), (0.0034475297359602818,0), (0.0034254322746483461, 0), (0.0034033348133364096, 0), (0.0033812373520244739, 0), (0.0033591398907125373, 0), (0.0033370424294006011, 0)], ('USD', 'BTC'): [(0.00026852846401718581, 0), (0.0002667351238303353, 0), (0.00026564031220578958, 0), (0.00026454550058124386, 0), (0.00026345068895669815, 0), (0.00026235587733215238, 0), (0.00026126106570760672, 0)], ('ETH', 'USD'): [(285.45999999999998, 0), (289.82460874547951, 0), (291.55112411406469, 0), (293.27763948264976, 0), (295.00415485123489, 0), (296.73067021982007, 0), (298.4571855884052, 0)], ('ETH', 'BTC'): [(0.076613856068743283, 0), (0.077467777631156851, 0), (0.077700391031094967, 0), (0.077933004431033098, 0), (0.078165617830971215, 0), (0.078398231230909332, 0), (0.078630844630847435, 0)], ('BTC', 'ETH'): [(13.052469243980232, 0), (12.908397378262773, 0), (12.869208798698921, 0), (12.830020219135069, 0), (12.790831639571218, 0), (12.751643060007366, 0), (12.712454480443514, 0)], ('BTC', 'USD'): [(3724.0, 0), (3748.7100581594359, 0), (3763.7776696940145, 0), (3778.8452812285923, 0), (3793.9128927631705, 0), (3808.9805042977491, 0), (3824.0481158323273, 0)]}, 'bitfinex': {('USD', 'ETH'): [(0.0035238565085629718, 0), (0.0034522741937610918, 0), (0.0034266474201768383, 0), (0.0034010206465925849, 0), (0.0033753938730083314, 0), (0.0033497670994240779, 0), (0.003324140325839824, 0)], ('USD', 'BTC'): [(0.00027049690281046279, 0), (0.00026796309259241276, 0), (0.00026686550806498161, 0), (0.00026576792353755039, 0), (0.00026467033901011918, 0), (0.00026357275448268803, 0), (0.00026247516995525681, 0)], ('ETH', 'USD'): [(283.77999999999997, 0), (289.51431376171172, 0), (291.55335357040519, 0), (293.59239337909872, 0), (295.63143318779214, 0), (297.67047299648567, 0), (299.7095128051792, 0)], ('ETH', 'BTC'): [(0.07722416078335903, 0), (0.077925333029647617, 0), (0.078174918726735348, 0), (0.078424504423823094, 0), (0.078674090120910825, 0), (0.078923675817998556, 0), (0.079173261515086274, 0)], ('BTC', 'ETH'): [(12.949315212441768, 0), (12.832463772737603, 0), (12.790778719134339, 0), (12.749093665531076, 0), (12.707408611927811, 0), (12.665723558324547, 0), (12.624038504721282, 0)], ('BTC', 'USD'): [(3696.9000000000001, 0), (3731.4008878009654, 0), (3746.3056371206576, 0), (3761.2103864403493, 0), (3776.1151357600411, 0), (3791.0198850797337, 0), (3805.924634399425, 0)]}, 'gdax': {('USD', 'ETH'): [(0.0034990727457223834, 0), (0.0034414606599142356, 0), (0.0034153130765328956, 0), (0.003389165493151556, 0), (0.0033630179097702156, 0), (0.0033368703263888756, 0), (0.0033107227430075356, 0)], ('USD', 'BTC'): [(0.00026907253388295887, 0), (0.00026681863488424982, 0), (0.00026553127725668224, 0), (0.00026424391962911461, 0), (0.00026295656200154703, 0), (0.0002616692043739794, 0), (0.00026038184674641177, 0)], ('ETH', 'USD'): [(285.79000000000002, 0), (290.49130565697465, 0), (292.61633426039322, 0), (294.74136286381179, 0), (296.86639146723036, 0), (298.99142007064893, 0), (301.11644867406756, 0)], ('ETH', 'BTC'): [(0.076978961218575684, 0), (0.077584013347898328, 0), (0.077783434400255369, 0), (0.077982855452612396, 0), (0.078182276504969436, 0), (0.078381697557326463, 0), (0.078581118609683503, 0)], ('BTC', 'ETH'): [(12.990562410430286, 0), (12.890977373355506, 0), (12.858442278181805, 0), (12.825907183008104, 0), (12.793372087834401, 0),(12.7608369926607, 0), (12.728301897486999, 0)], ('BTC', 'USD'): [(3716.4699999999998, 0), (3747.4155849981807, 0), (3765.0687744189795, 0), (3782.7219638397783, 0), (3800.3751532605775, 0), (3818.0283426813753, 0), (3835.6815321021745, 0)]}}
  arbitrage_search_problem = ArbitrageSearchProblem(predictions_tree, depth_limit=6)
  actions, result = brutebfs(arbitrage_search_problem)
  print(result)
  assert result == 105.76016430088377
  assert actions == [ArbitrageSearchNode(exchange='bank', currency='USD', amount=100, timestep=0, already_transferred=False), ArbitrageSearchNode(exchange='bitstamp', currency='USD', amount=100, timestep=0, already_transferred=False), ArbitrageSearchNode(exchange='bitstamp', currency='ETH', amount=0.35122002746382175, timestep=0, already_transferred=True), ArbitrageSearchNode(exchange='bitstamp', currency='ETH', amount=0.35122002746382175, timestep=1, already_transferred=True), ArbitrageSearchNode(exchange='bitstamp', currency='ETH', amount=0.35122002746382175, timestep=2, already_transferred=True), ArbitrageSearchNode(exchange='bitstamp', currency='ETH', amount=0.35122002746382175, timestep=3, already_transferred=True), ArbitrageSearchNode(exchange='bitstamp', currency='ETH', amount=0.35122002746382175, timestep=4, already_transferred=True), ArbitrageSearchNode(exchange='gemini', currency='ETH', amount=0.35122002746382175, timestep=5, already_transferred=False), ArbitrageSearchNode(exchange='gemini', currency='BTC', amount=0.02765568481417821, timestep=5, already_transferred=True), ArbitrageSearchNode(exchange='gdax', currency='BTC', amount=0.02765568481417821, timestep=6, already_transferred=False), ArbitrageSearchNode(exchange='gdax', currency='USD', amount=105.76016430088377, timestep=6, already_transferred=True)]
  print('bfs.py passed all tests')
